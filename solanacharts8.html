<!DOCTYPE html>
<html>
<head>
    <title>L1 Blockchain Metrics (2x2, Live Line Charts, 10min, Optimized)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .chart-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 1300px;
            margin: auto;
        }
        .chart-box {
            width: 600px;
            height: 300px;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
        }
        #refresh-indicator, #error-message {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }
        #refresh-indicator { color: #333; }
        #error-message { color: #ff0000; display: none; }
    </style>
</head>
<body>
    <div class="chart-container">
        <div class="chart-box"><canvas id="stablecoinSupplyChart"></canvas></div>
        <div class="chart-box"><canvas id="tvlToSupplyChart"></canvas></div>
        <div class="chart-box"><canvas id="scalabilityChart"></canvas></div>
        <div class="chart-box"><canvas id="ecosystemDiversityChart"></canvas></div>
    </div>
    <div id="refresh-indicator">Last Refresh: Initializing...</div>
    <div id="error-message">Error: Connection issue. Retrying...</div>

    <script>
        try {
            const chains = ['Ethereum', 'Tron', 'Solana', 'BNB Chain', 'Arbitrum', 'Polygon'];
            const colors = [
                'rgba(54, 162, 235, 0.8)',  // Ethereum: Blue
                'rgba(255, 99, 132, 0.8)',  // Tron: Red
                'rgba(20, 241, 149, 0.8)',  // Solana: Green (#14F195)
                'rgba(255, 159, 64, 0.8)',  // BNB Chain: Orange
                'rgba(153, 102, 255, 0.8)', // Arbitrum: Purple
                'rgba(75, 192, 192, 0.8)'   // Polygon: Teal
            ];
            const borderColors = colors.map(c => c.replace('0.8', '1'));

            // Initial data arrays (100-minute window, 10-min increments)
            let timestamps = Array(10).fill().map((_, i) => new Date(Date.now() - (9 - i) * 600000).toLocaleTimeString('en-US', { timeZone: 'America/New_York' }));
            let stablecoinData = Array(6).fill().map(() => Array(10).fill(0));
            stablecoinData[0] = Array(10).fill(135.4); // Ethereum
            stablecoinData[1] = Array(10).fill(66.2);  // Tron
            stablecoinData[2] = Array(10).fill(12.5);  // Solana (will update live)
            stablecoinData[3] = Array(10).fill(7.0);   // BNB Chain
            stablecoinData[4] = Array(10).fill(3.5);   // Arbitrum
            stablecoinData[5] = Array(10).fill(2.0);   // Polygon
            let tvlToSupplyData = Array(6).fill().map(() => Array(10).fill(0));
            tvlToSupplyData[0] = Array(10).fill(0.492); // Ethereum
            tvlToSupplyData[1] = Array(10).fill(0.112); // Tron
            tvlToSupplyData[2] = Array(10).fill(0.947); // Solana
            tvlToSupplyData[3] = Array(10).fill(0.843); // BNB Chain
            tvlToSupplyData[4] = Array(10).fill(0.874); // Arbitrum
            tvlToSupplyData[5] = Array(10).fill(0.450); // Polygon
            let scalabilityData = Array(6).fill().map(() => Array(10).fill(0));
            scalabilityData[0] = Array(10).fill(20);    // Ethereum
            scalabilityData[1] = Array(10).fill(2000);  // Tron
            scalabilityData[2] = Array(10).fill(2500);  // Solana
            scalabilityData[3] = Array(10).fill(200);   // BNB Chain
            scalabilityData[4] = Array(10).fill(4000);  // Arbitrum
            scalabilityData[5] = Array(10).fill(700);   // Polygon
            let ecosystemData = Array(6).fill().map(() => Array(10).fill(0));
            ecosystemData[0] = Array(10).fill(4000);    // Ethereum
            ecosystemData[1] = Array(10).fill(1000);    // Tron
            ecosystemData[2] = Array(10).fill(2000);    // Solana
            ecosystemData[3] = Array(10).fill(1500);    // BNB Chain
            ecosystemData[4] = Array(10).fill(500);     // Arbitrum
            ecosystemData[5] = Array(10).fill(1000);    // Polygon

            // Chart instances with labels and auto-scaling y-axes
            const charts = {
                stablecoinSupplyChart: new Chart(document.getElementById('stablecoinSupplyChart'), {
                    type: 'line',
                    data: { labels: timestamps, datasets: chains.map((chain, i) => ({
                        label: chain,
                        data: stablecoinData[i],
                        backgroundColor: colors[i],
                        borderColor: borderColors[i],
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 2
                    })) },
                    options: {
                        scales: { y: { beginAtZero: true } },
                        plugins: {
                            legend: { display: true },
                            tooltip: { enabled: true },
                            title: { display: true, text: 'Stablecoin Supply ($B)' }
                        },
                        maintainAspectRatio: false
                    }
                }),
                tvlToSupplyChart: new Chart(document.getElementById('tvlToSupplyChart'), {
                    type: 'line',
                    data: { labels: timestamps, datasets: chains.map((chain, i) => ({
                        label: chain,
                        data: tvlToSupplyData[i],
                        backgroundColor: colors[i],
                        borderColor: borderColors[i],
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 2
                    })) },
                    options: {
                        scales: { y: { beginAtZero: true } },
                        plugins: {
                            legend: { display: true },
                            tooltip: { enabled: true },
                            title: { display: true, text: 'TVL-to-Supply Ratio' }
                        },
                        maintainAspectRatio: false
                    }
                }),
                scalabilityChart: new Chart(document.getElementById('scalabilityChart'), {
                    type: 'line',
                    data: { labels: timestamps, datasets: chains.map((chain, i) => ({
                        label: chain,
                        data: scalabilityData[i],
                        backgroundColor: colors[i],
                        borderColor: borderColors[i],
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 2
                    })) },
                    options: {
                        scales: { y: { beginAtZero: true } },
                        plugins: {
                            legend: { display: true },
                            tooltip: { enabled: true },
                            title: { display: true, text: 'Scalability (TPS)' }
                        },
                        maintainAspectRatio: false
                    }
                }),
                ecosystemDiversityChart: new Chart(document.getElementById('ecosystemDiversityChart'), {
                    type: 'line',
                    data: { labels: timestamps, datasets: chains.map((chain, i) => ({
                        label: chain,
                        data: ecosystemData[i],
                        backgroundColor: colors[i],
                        borderColor: borderColors[i],
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 2
                    })) },
                    options: {
                        scales: { y: { beginAtZero: true } },
                        plugins: {
                            legend: { display: true },
                            tooltip: { enabled: true },
                            title: { display: true, text: 'Ecosystem Diversity (dApps)' }
                        },
                        maintainAspectRatio: false
                    }
                })
            };

            // WebSocket with reconnection logic
            const ws = new WebSocket('wss://your-quicknode-endpoint.example'); // Replace with your QuickNode WSS URL
            const refreshIndicator = document.getElementById('refresh-indicator');
            const errorMessage = document.getElementById('error-message');
            let reconnectTimeout;

            function connectWebSocket() {
                ws.onopen = () => {
                    ws.send(JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'accountSubscribe',
                        params: [
                            'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', // USDC mint address
                            { commitment: 'confirmed', encoding: 'jsonParsed' }
                        ]
                    }));
                    errorMessage.style.display = 'none';
                    updateChartsAndTime();
                };

                ws.onmessage = (event) => {
                    const response = JSON.parse(event.data);
                    if (response.result && response.params) {
                        const accountInfo = response.params.result.value;
                        if (accountInfo && accountInfo.data && accountInfo.data.parsed) {
                            const supply = accountInfo.data.parsed.info.supply / 1_000_000; // Convert lamports to USDC
                            stablecoinData[2].shift();
                            stablecoinData[2].push(supply);
                            interpolateAndUpdate();
                            console.log(`Live Solana USDC Supply: $${supply.toFixed(2)}B`);
                        }
                    }
                };

                ws.onerror = () => {
                    errorMessage.style.display = 'block';
                    reconnect();
                };

                ws.onclose = () => {
                    errorMessage.style.display = 'block';
                    reconnect();
                };
            }

            function reconnect() {
                if (reconnectTimeout) clearTimeout(reconnectTimeout);
                reconnectTimeout = setTimeout(() => {
                    ws = new WebSocket('wss://your-quicknode-endpoint.example'); // Replace with your QuickNode WSS URL
                    connectWebSocket();
                }, 5000); // Retry after 5 seconds
            }

            connectWebSocket();

            // Smoother updates with 1-minute interpolation
            let lastSupply = 12.5;
            function interpolateAndUpdate() {
                const now = new Date();
                const nextUpdate = new Date(Math.ceil(now / 600000) * 600000);
                const timeDiff = (nextUpdate - now) / 60000; // Minutes until next 10-min update
                if (timeDiff < 10) {
                    const supply = stablecoinData[2][stablecoinData[2].length - 1];
                    const interpolated = lastSupply + (supply - lastSupply) * (1 - timeDiff / 10);
                    stablecoinData[2][stablecoinData[2].length - 1] = interpolated;
                    lastSupply = interpolated;
                }
                updateChartsAndTime();
            }

            // Update charts and timestamps every 10 minutes
            setInterval(updateChartsAndTime, 600000); // 10 minutes = 600,000 ms
            setInterval(interpolateAndUpdate, 60000); // 1 minute = 60,000 ms for smoother updates

            function updateChartsAndTime() {
                timestamps.shift();
                timestamps.push(new Date().toLocaleTimeString('en-US', { timeZone: 'America/New_York' }));
                charts.stablecoinSupplyChart.data.labels = timestamps;
                charts.tvlToSupplyChart.data.labels = timestamps;
                charts.scalabilityChart.data.labels = timestamps;
                charts.ecosystemDiversityChart.data.labels = timestamps;
                charts.stablecoinSupplyChart.data.datasets[0].data = stablecoinData.map(row => row.slice(-10));
                charts.tvlToSupplyChart.data.datasets[0].data = tvlToSupplyData.map(row => row.slice(-10));
                charts.scalabilityChart.data.datasets[0].data = scalabilityData.map(row => row.slice(-10));
                charts.ecosystemDiversityChart.data.datasets[0].data = ecosystemData.map(row => row.slice(-10));
                charts.stablecoinSupplyChart.update('active');
                charts.tvlToSupplyChart.update('active');
                charts.scalabilityChart.update('active');
                charts.ecosystemDiversityChart.update('active');
                refreshIndicator.textContent = `Last Refresh: ${new Date().toLocaleString('en-US', { timeZone: 'America/New_York' })}`;
            }

        } catch (error) {
            console.error('Error rendering charts:', error);
            errorMessage.style.display = 'block';
            errorMessage.textContent = `Error: ${error.message}. Retrying...`;
        }
    </script>
</body>
</html>